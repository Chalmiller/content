# platform = Red Hat Enterprise Linux 7,Red Hat Enterprise Linux 8,Red Hat Virtualization 4,multi_platform_wrlinux,multi_platform_ol,multi_platform_sle,multi_platform_fedora
# complexity = low
# reboot = false
# disruption = low
# strategy = restrict
- package_facts:
    manager: auto
  name: Gather the package facts
  tags:
    - CCE-80434-4
    - DISA-STIG-RHEL-07-020610
    - accounts_have_homedir_login_defs
    - low_complexity
    - low_disruption
    - medium_severity
    - no_reboot_needed
    - restrict_strategy

- name: Ensure new users receive home directories
  block:

    - name: Deduplicate values from /etc/login.defs
      lineinfile:
        path: /etc/login.defs
        create: false
        regexp: ^\s*CREATE_HOME\s+
        state: absent

    - name: Insert correct line to /etc/login.defs
      lineinfile:
        path: /etc/login.defs
        create: true
        line: CREATE_HOME yes
        state: present
  when: '"shadow-utils" in ansible_facts.packages'
  tags:
    - CCE-80434-4
    - DISA-STIG-RHEL-07-020610
    - accounts_have_homedir_login_defs
    - low_complexity
    - low_disruption
    - medium_severity
    - no_reboot_needed
    - restrict_strategy
